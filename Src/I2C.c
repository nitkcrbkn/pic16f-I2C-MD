///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//æœ¨æ›´æ´¥é«˜å°‚ãƒ­ãƒœãƒƒãƒˆç ”ç©¶åŒå¥½ä¼š
//I2Cé€šä¿¡ç”¨é–¢æ•°
//Use device microchip PIC16F1938
//MPLAB X IDE(ver.2.30)
//HI-TECH C Compiler for PIC10/12/16 MCUs Version 9.80 in Lite mode
//Last updata 2015/5/13/
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
#include<htc.h>
#include"I2C.h"
uint8_t rcv_data[RCV_DATA_LEN]; // å—ä¿¡ãƒ‡ãƒ¼ã‚¿ãƒãƒƒãƒ•ã‚¡
uint8_t snd_data[SND_DATA_LEN]; // é€ä¿¡ãƒ‡ãƒ¼ã‚¿ãƒãƒƒãƒ•ã‚¡


int8_t rcv_flg; // ãƒ‡ãƒ¼ã‚¿å—ä¿¡å›æ•°ã‚’ä¿å­˜ã™ã‚‹ãƒ•ãƒ©ã‚°
uint8_t *Sdtp; // ï¿½ï¿½ï¿½Mï¿½fï¿½[ï¿½^ï¿½oï¿½bï¿½tï¿½@ï¿½ÌƒAï¿½hï¿½ï¿½ï¿½Xï¿½|ï¿½Cï¿½ï¿½ï¿½^ï¿½[
uint8_t *Rdtp; // ï¿½ï¿½Mï¿½fï¿½[ï¿½^ï¿½oï¿½bï¿½tï¿½@ï¿½ÌƒAï¿½hï¿½ï¿½ï¿½Xï¿½|ï¿½Cï¿½ï¿½ï¿½^ï¿½[

int8_t AckCheck;
int8_t success;
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//I2Cã®åˆæœŸåŒ–ã‚’è¡Œã†é–¢æ•°
//ï¿½Eï¿½ï¿½ï¿½ï¿½@		ï¿½Eï¿½Lï¿½q
//  Master  void I2C_init(unsigned char speed); spped = é€šä¿¡é€Ÿåº¦(default 0x4f)(Fosc = 32MHz)
//  Slave   void I2C_init(unsigned char add);   add = ã‚¹ãƒ¬ãƒ¼ãƒ–å´ã®ã‚¢ãƒ‰ãƒ¬ã‚¹, ã‚µã‚¤ã‚ºã¯1Byte
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
#ifdef  Master

void I2C_init(uint8_t speed)
#endif
#ifdef  Slave
void I2C_init(uint8_t add)
#endif
{
#ifdef Master
    SSPSTAT = 0x80;
    SSPCON1 = 0x28;
    SSPADD = speed;
    SSPIE = 1; // SSP(I2C)ï¿½ï¿½ï¿½èï¿½İ‚ï¿½ï¿½ï¿½ï¿½Â‚ï¿½ï¿½ï¿½
    BCLIE = 1; // MSSP(I2C)ï¿½oï¿½Xï¿½Õ“ËŠï¿½ï¿½èï¿½İ‚ï¿½ï¿½ï¿½ï¿½Â‚ï¿½ï¿½ï¿½
    PEIE = 1; // ï¿½ï¿½ï¿½Ó‘ï¿½ï¿½uï¿½ï¿½ï¿½èï¿½İ‚ï¿½ï¿½ï¿½ï¿½Â‚ï¿½ï¿½ï¿½
    GIE = 1; // ï¿½Sï¿½ï¿½ï¿½èï¿½İï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Â‚ï¿½ï¿½ï¿½
    SSPIF = 0; // SSP(I2C)ï¿½ï¿½ï¿½èï¿½İƒtï¿½ï¿½ï¿½Oï¿½ï¿½ï¿½Nï¿½ï¿½ï¿½Aï¿½ï¿½ï¿½ï¿½
    BCLIF = 0; // MSSP(I2C)ï¿½oï¿½Xï¿½Õ“ËŠï¿½ï¿½èï¿½İƒtï¿½ï¿½ï¿½Oï¿½ï¿½ï¿½Nï¿½ï¿½ï¿½Aï¿½ï¿½ï¿½ï¿½
    pinModeSCK = 1;
    pinModeSDA = 1;

#endif
#ifdef Slave
    SSPSTAT = 0x00;
    SSPCON1 = 0x26;
    SEN = 1;
    SSPADD = add << 1;
    SSPMSK = 0xfe;
    SSPIE = 1; // SSP(I2C)ï¿½ï¿½ï¿½èï¿½İ‚ï¿½ï¿½ï¿½ï¿½Â‚ï¿½ï¿½ï¿½
    BCLIE = 1; // MSSP(I2C)ï¿½oï¿½Xï¿½Õ“ËŠï¿½ï¿½èï¿½İ‚ï¿½ï¿½ï¿½ï¿½Â‚ï¿½ï¿½ï¿½
    PEIE = 1; // ï¿½ï¿½ï¿½Ó‘ï¿½ï¿½uï¿½ï¿½ï¿½èï¿½İ‚ï¿½ï¿½ï¿½ï¿½Â‚ï¿½ï¿½ï¿½
    GIE = 1; // ï¿½Sï¿½ï¿½ï¿½èï¿½İï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Â‚ï¿½ï¿½ï¿½
    SSPIF = 0; // SSP(I2C)ï¿½ï¿½ï¿½èï¿½İƒtï¿½ï¿½ï¿½Oï¿½ï¿½ï¿½Nï¿½ï¿½ï¿½Aï¿½ï¿½ï¿½ï¿½
    BCLIF = 0;
    pinModeSCK = 1;
    pinModeSDA = 1;
#endif
}
/**************************************Master_Mode********************************************/
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Masterã®å‰²ã‚Šè¾¼ã¿é–¢æ•°
//  void interrupt **(void)ï¿½Ì’ï¿½ï¿½É“ï¿½ï¿½ï¿½Ä‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½B
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
#ifdef Master

void Master_Interrupt(void) {
    if (SSPIF == 1) { // SSP(I2C)ï¿½ï¿½ï¿½èï¿½İ‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½f
        if (AckCheck == 1) AckCheck = 0;
        SSPIF = 0; // ï¿½tï¿½ï¿½ï¿½Oï¿½Nï¿½ï¿½ï¿½A
    } else if (BCLIF == 1) { // MSSP(I2C)ï¿½oï¿½Xï¿½Õ“ËŠï¿½ï¿½èï¿½İ‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½f
        BCLIF = 0; // ï¿½ï¿½ï¿½ï¿½Íƒtï¿½ï¿½ï¿½Oï¿½Ì‚İƒNï¿½ï¿½ï¿½Aï¿½ï¿½ï¿½ï¿½(ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½)
    }
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//ans = I2C_Send(adrs,len,*buf) : I2Cé€ä¿¡é–¢æ•°
//
//  adrs = é€ä¿¡å…ˆã‚¢ãƒ‰ãƒ¬ã‚¹
//  len  = é€ä¿¡ãƒ‡ãƒ¼ã‚¿ã®é•·ã•
//  buf  = é€ä¿¡ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒãƒ•ã‚¡ãƒã‚¤ãƒ³ã‚¿
//  ans  = 0:æ­£å¸¸çµ‚äº†, 1:å¿œç­”ç„¡ã—, 2:å—ä¿¡æ‹’å¦
//  ï¿½ï¿½ï¿½Mï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ÆAansï¿½Åï¿½Ô‚ï¿½ï¿½mï¿½F
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////

uint8_t I2C_Send(uint8_t adrs, uint8_t len, uint8_t *buf) {
    uint8_t i;
    int8_t ans;

    // ï¿½Xï¿½^ï¿½[ï¿½g(START CONDITION)
    I2C_IdleCheck(0x5);
    SSPCON2bits.SEN = 1;
    // [ï¿½Xï¿½ï¿½ï¿½[ï¿½uï¿½ÌƒAï¿½hï¿½ï¿½ï¿½X+ï¿½Xï¿½ï¿½ï¿½[ï¿½uï¿½Íï¿½Mï¿½ï¿½vï¿½ï¿½]ï¿½ğ‘—Mï¿½ï¿½ï¿½ï¿½
    I2C_IdleCheck(0x5);
    AckCheck = 1;
    SSPBUF = (uint8_t) (adrs << 1); // ï¿½Aï¿½hï¿½ï¿½ï¿½Xï¿½ğ‘—M R/W=0
    while (AckCheck); // ï¿½ï¿½ï¿½è‚©ï¿½ï¿½ï¿½ACKï¿½Ô“ï¿½ï¿½ï¿½Ò‚ï¿½
    ans = SSPCON2bits.ACKSTAT;
    if (ans == 0) {
        for (i = 0; i < len; i++) { // [ï¿½fï¿½[ï¿½^]ï¿½ğ‘—Mï¿½ï¿½ï¿½ï¿½
            I2C_IdleCheck(0x5);
            AckCheck = 1;
            SSPBUF = (unsigned char) *buf; // ï¿½fï¿½[ï¿½^ï¿½ğ‘—M
            buf++;
            while (AckCheck); // ï¿½ï¿½ï¿½è‚©ï¿½ï¿½ï¿½ACKï¿½Ô“ï¿½ï¿½ï¿½Ò‚ï¿½
            ans = SSPCON2bits.ACKSTAT;
            if (ans != 0) {
                ans = 2; // ï¿½ï¿½ï¿½è‚ªNOACKï¿½ï¿½Ô‚ï¿½ï¿½ï¿½
                success = 1; //ï¿½mï¿½Fï¿½p
                break;
            }
        }
    }
    // ï¿½Xï¿½gï¿½bï¿½v(STOP CONDITION)
    I2C_IdleCheck(0x5);
    SSPCON2bits.PEN = 1;
    return ans;
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//int I2C_Receive(adrs,len,*buf) : I2Cå—ä¿¡é–¢æ•°
//  data = ï¿½ï¿½Mï¿½fï¿½[ï¿½^ï¿½ÛŠÇ—pï¿½Ïï¿½
//  adrs = å—ä¿¡å…ˆã‚¢ãƒ‰ãƒ¬ã‚¹
//  len  = å—ä¿¡ãƒ‡ãƒ¼ã‚¿ã®é•·ã•
//  ans  = 0:æ­£å¸¸çµ‚äº†, 1:å¿œç­”ç„¡ã—, 2:é€ä¿¡æ‹’å¦
//  *buf = å—ä¿¡ãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œã‚‹ãƒãƒƒãƒ•ã‚¡ãƒã‚¤ãƒ³ã‚¿
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////

uint8_t I2C_Receive(uint8_t adrs, uint8_t len, uint8_t *buf) {
    //	 uint8_t data = 0 ;

    uint8_t i, ans;

    // ï¿½Xï¿½^ï¿½[ï¿½g(START CONDITION)
    I2C_IdleCheck(0x5);
    SSPCON2bits.SEN = 1;
    // [ï¿½Xï¿½ï¿½ï¿½[ï¿½uï¿½ÌƒAï¿½hï¿½ï¿½ï¿½X+ï¿½Xï¿½ï¿½ï¿½[ï¿½uï¿½Öƒfï¿½[ï¿½^ï¿½vï¿½ï¿½]ï¿½ğ‘—Mï¿½ï¿½ï¿½ï¿½
    I2C_IdleCheck(0x5);
    AckCheck = 1;
    SSPBUF = (char) ((adrs << 1) + 1); // ï¿½Aï¿½hï¿½ï¿½ï¿½Xï¿½ğ‘—M R/W=1
    while (AckCheck); // ï¿½ï¿½ï¿½è‚©ï¿½ï¿½ï¿½ACKï¿½Ô“ï¿½ï¿½ï¿½Ò‚ï¿½
    ans = SSPCON2bits.ACKSTAT;
    if (ans == 0) {
        for (i = 0; i < len; i++) { // [ï¿½fï¿½[ï¿½^]ï¿½ï¿½ï¿½ï¿½Mï¿½ï¿½ï¿½ï¿½
            I2C_IdleCheck(0x5);
            SSPCON2bits.RCEN = 1; // ï¿½ï¿½Mï¿½ï¿½ï¿½ï¿½ï¿½Â‚ï¿½ï¿½ï¿½
            I2C_IdleCheck(0x4);
            *(buf + i) = SSPBUF; // ï¿½ï¿½M
            //data = SSPBUF; //ï¿½ï¿½Ma
            //buf++ ;
            I2C_IdleCheck(0x5);
            if (i = len) SSPCON2bits.ACKDT = 1; // ACKï¿½fï¿½[ï¿½^ï¿½ï¿½NOACK
            else SSPCON2bits.ACKDT = 0; // ACKï¿½fï¿½[ï¿½^ï¿½ï¿½ACK
            SSPCON2bits.ACKEN = 1; // ACKï¿½fï¿½[ï¿½^ï¿½ï¿½Ô‚ï¿½
        }
    }
    // ï¿½Xï¿½gï¿½bï¿½v(STOP CONDITION)
    I2C_IdleCheck(0x5);
    SSPCON2bits.PEN = 1;
    return ans;
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//I2C_IdleCheck(char mask) : I2Cã®å¾…æ©Ÿé–¢æ•°
//  ACKEN RCEN PEN RSEN SEN R/W BF ï¿½ï¿½ï¿½Sï¿½Ä‚Oï¿½È‚ï¿½nï¿½j
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void I2C_IdleCheck(uint8_t mask) {
    while ((SSPCON2 & 0x1F) | (SSPSTAT & mask));
}
#endif
/***************************************Slave_Mode*********************************************/
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Slaveã®å‰²ã‚Šè¾¼ã¿é–¢æ•°
//  void interrupt **(void)ï¿½Ì’ï¿½ï¿½É“ï¿½ï¿½ï¿½Ä‚ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½B
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
#ifdef Slave

void Slave_Interrupt(void) {
    char x;

    /*** SSP(I2C)ï¿½ï¿½ï¿½èï¿½İ”ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ìï¿½ï¿½ï¿½***/
    if (SSPIF == 1) { //
        if (SSPSTATbits.R_nW == 0) {
            /******* ï¿½}ï¿½Xï¿½^ï¿½[ï¿½ï¿½ï¿½ï¿½Ìï¿½ï¿½ï¿½ï¿½ï¿½ï¿½İ—vï¿½ï¿½(ï¿½Xï¿½ï¿½ï¿½[ï¿½uï¿½Íï¿½M) *******/
            if (SSPSTATbits.D_nA == 0) {
                // ï¿½ï¿½Mï¿½oï¿½Cï¿½gï¿½ÍƒAï¿½hï¿½ï¿½ï¿½X
                Rdtp = (char *) rcv_data;
                x = SSPBUF; // ï¿½Aï¿½hï¿½ï¿½ï¿½Xï¿½fï¿½[ï¿½^ï¿½ï¿½ï¿½ï¿½Ç‚İ‚ï¿½ï¿½ï¿½
                rcv_flg = 0;
            } else {
                // ï¿½ï¿½Mï¿½oï¿½Cï¿½gï¿½Íƒfï¿½[ï¿½^
                *Rdtp = SSPBUF; // ï¿½fï¿½[ï¿½^ï¿½ï¿½Çï¿½ï¿½ï¿½(ACKï¿½ï¿½PICï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Iï¿½É•Ô‚ï¿½)
                Rdtp++;
                rcv_flg++;
            }
            SSPIF = 0; // ï¿½ï¿½ï¿½ï¿½ï¿½İƒtï¿½ï¿½ï¿½Oï¿½Nï¿½ï¿½ï¿½A
            SSPCON1bits.CKP = 1; // SCLï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½Jï¿½ï¿½ï¿½ï¿½ï¿½ï¿½(ï¿½ÊMï¿½ÌÄŠJ)
        } else {
            /******* ï¿½}ï¿½Xï¿½^ï¿½[ï¿½ï¿½ï¿½ï¿½Ì“Ç‚İoï¿½ï¿½ï¿½vï¿½ï¿½(ï¿½Xï¿½ï¿½ï¿½[ï¿½uï¿½Í‘ï¿½ï¿½M) *******/
            if (SSPSTATbits.BF == 1) {
                // ï¿½Aï¿½hï¿½ï¿½ï¿½Xï¿½ï¿½Mï¿½ï¿½ÌŠï¿½ï¿½èï¿½İ‚Æ”ï¿½ï¿½fï¿½ï¿½ï¿½ï¿½
                Sdtp = (char *) snd_data;
                x = SSPBUF; // ï¿½Aï¿½hï¿½ï¿½ï¿½Xï¿½fï¿½[ï¿½^ï¿½ï¿½ï¿½ï¿½Ç‚İ‚ï¿½ï¿½ï¿½
                while ((SSPCON1bits.CKP) | (SSPSTATbits.BF));
                SSPBUF = *Sdtp; // ï¿½ï¿½ï¿½Mï¿½fï¿½[ï¿½^ï¿½ÌƒZï¿½bï¿½g
                Sdtp++;
                SSPIF = 0; // ï¿½ï¿½ï¿½ï¿½ï¿½İƒtï¿½ï¿½ï¿½Oï¿½Nï¿½ï¿½ï¿½A
                SSPCON1bits.CKP = 1; // SCLï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½Jï¿½ï¿½ï¿½ï¿½ï¿½ï¿½(ï¿½ÊMï¿½ÌÄŠJ)
            } else {
                // ï¿½fï¿½[ï¿½^ï¿½Ì‘ï¿½ï¿½Mï¿½ï¿½ï¿½ACKï¿½ó‚¯ï¿½ï¿½É‚ï¿½éŠ„ï¿½èï¿½İ‚Æ”ï¿½ï¿½fï¿½ï¿½ï¿½ï¿½
                if (SSPCON2bits.ACKSTAT == 0) {
                    // ï¿½}ï¿½Xï¿½^ï¿½[ï¿½ï¿½ï¿½ï¿½ACKï¿½ï¿½ï¿½ï¿½ï¿½È‚çŸï¿½Ìƒfï¿½[ï¿½^ï¿½ğ‘—Mï¿½ï¿½ï¿½ï¿½
                    while ((SSPCON1bits.CKP) | (SSPSTATbits.BF));
                    SSPBUF = *Sdtp; // ï¿½ï¿½ï¿½Mï¿½fï¿½[ï¿½^ï¿½ÌƒZï¿½bï¿½g
                    Sdtp++;
                    SSPIF = 0; // ï¿½ï¿½ï¿½ï¿½ï¿½İƒtï¿½ï¿½ï¿½Oï¿½Nï¿½ï¿½ï¿½A
                    SSPCON1bits.CKP = 1; // SCLï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½Jï¿½ï¿½ï¿½ï¿½ï¿½ï¿½(ï¿½ÊMï¿½ÌÄŠJ)
                } else {
                    // ï¿½}ï¿½Xï¿½^ï¿½[ï¿½ï¿½ï¿½ï¿½ï¿½NOACKï¿½Å‰ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ê‚½ï¿½ï¿½
                    SSPIF = 0; // ï¿½ï¿½ï¿½ï¿½ï¿½İƒtï¿½ï¿½ï¿½Oï¿½Nï¿½ï¿½ï¿½A
                }
            }
        }
    }

    /* MSSP(I2C)ï¿½oï¿½Xï¿½Õ“ËŠï¿½ï¿½èï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ìï¿½ï¿½ï¿½*/
    if (BCLIF == 1) {
        BCLIF = 0; // ï¿½ï¿½ï¿½ï¿½Íƒtï¿½ï¿½ï¿½Oï¿½Ì‚İƒNï¿½ï¿½ï¿½Aï¿½ï¿½ï¿½ï¿½(ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½)
    }
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//int I2C_ReceiveCheck() : ãƒ‡ãƒ¼ã‚¿å—ä¿¡å›æ•°ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦rcv_flgã‚’ã‚¯ãƒªã‚¢ã™ã‚‹é–¢æ•°
//  ans = ãƒ‡ãƒ¼ã‚¿å—ä¿¡å›æ•°
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////

uint8_t I2C_ReceiveCheck() {
    int ans;

    ans = 0;
    if (rcv_flg != 0) { // å—ä¿¡ã—ãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã£ãŸã‚‰
        if ((SSPSTATbits.S == 0)&&(SSPSTATbits.P == 1)) { // ï¿½Ä¯ï¿½ßºï¿½ï¿½Ş¨ï¿½ï¿½İ”ï¿½ï¿½sï¿½ï¿½ï¿½ê‚½ï¿½ï¿½ï¿½ï¿½
            ans = rcv_flg;
            rcv_flg = 0;
        }
    }
    return (ans);
}
#endif
